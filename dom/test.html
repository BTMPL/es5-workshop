<!doctype html>
<html>
    <head>
        <title>Moja strona internetowa</title>
        <meta charset="utf-8" />

        <link href="https://cdnjs.cloudflare.com/ajax/libs/mocha/5.1.1/mocha.css" rel="stylesheet" />

                
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/5.1.1/mocha.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/sinon.js/5.0.7/sinon.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.1.2/chai.js"></script>
      
        <script>
          mocha.setup({
            ui: 'bdd'
          })
        </script>        
    </head>
    <body>
        <div id="mocha"></div>

        <script src="script.js"></script>
        <script>
            
            var expect = chai.expect;

            var requests;            
            beforeEach(function() {
              xhr = sinon.useFakeXMLHttpRequest();
              requests = this.requests = [];

              xhr.onCreate = function (xhr) {
                  requests.push(xhr);
              };    
            });   
            
            afterEach(function() {
              xhr.restore();
            });

            var fixtures = {
              posts: [
                {
                  id: 1,
                  title: 'test 1 title',
                  body: 'test 1 body'
                },
                {
                  id: 2,
                  title: 'test 2 title',
                  body: 'test 2 body'
                },
                {
                  id: 3,
                  title: 'test 3 title',
                  body: 'test 3 body'
                },
                {
                  id: 4,
                  title: 'test 4 title',
                  body: 'test 4 body'
                },
                {
                  id: 5,
                  title: 'test 5 title',
                  body: 'test 5 body'
                },
                {
                  id: 6,
                  title: 'test 6 title',
                  body: 'test 6 body'
                }                                
              ]
            };
                  
            describe('Router mechanism', function() {
              it('calls the loadPost function when navigating to a post', function() {
                var stub = sinon.stub(window, "loadPost");
                router('/test/1');
                expect(window.loadPost.calledWith('1')).to.equal(true);
                stub.restore();
              });
              it('calls the loadIndex function when navigating to index', function() {
                var stub = sinon.stub(window, "loadIndex");
                router('');
                expect(stub.called).to.equal(true);
                stub.restore();
              })              
            });

            describe('get and post helpers', function() {
              it('get helper passes back backend response', function() {
                var callback = sinon.fake();
                var data = JSON.stringify(fixtures.posts);
                get('//example.com', callback);
                requests[0].respond(200,{ "Content-Type": "application/json" }, data);

                expect(callback.calledWith(data)).to.equal(true);
              });

              it('post helper sets the expected header and converst object body to JSON', function() {
                var callback = sinon.fake();
                var data = fixtures.posts;
                var json = JSON.stringify(data);
                post('//example.com', data, callback);
                requests[0].respond(200, { "Content-Type": "application/json" }, json);

                expect(requests[0].requestHeaders['Content-Type']).to.contain('application/json');
                expect(requests[0].requestBody).to.equal(json);
              });
            });

            describe('index view', function() {
              it('loading posts sends the request, and tries to reneder the result', function() {
                var stub = sinon.stub(window, "renderPosts");
                loadIndex();
                var data = JSON.stringify(fixtures.posts);
                requests[0].respond(200,{ "Content-Type": "application/json" }, data);

                expect(stub.called).to.equal(true);
                stub.restore();
              })

              it('renderPosts renders the received items to a designated container', function() {
                var target = document.createElement('div');
                renderPosts(fixtures.posts, target);

                expect(target.querySelectorAll('li').length).to.equal(5);
              });

              it('clicking one ofthe rendered elements updates the URL', function() {
                var target = document.createElement('div');
                renderPosts(fixtures.posts, target);
                target.querySelector('li').click();
                expect(window.location.hash).to.equal('#post/' + fixtures.posts[0].id);
              })
            });            
            
        </script>

        <script>
          mocha.run();
        </script>        
    </body>
</html>

